name: vlan
package: interface
template: '@ansible/module/module.py.twig'
module_name: kilip.routeros.ros_vlan
export_command: '/interface vlan export'
resource_class_name: VlanResource
documentation:
  module: ros_vlan
  version_added: 1.0.0
  author: 'Anthonius Munthi (@kilip)'
  short_description: 'VLAN Resource Module'
  description:
    - 'This module manages the vlan configuration of Mikrotik RouterOS network devices.'
  options:
    state:
      choices:
        - merged
        - replaced
        - overridden
        - deleted
      default: merged
      description: 'Set state for this module'
    config:
      type: list
      elements: dict
      suboptions:
        arp:
          type: str
          choices:
            - disabled
            - enabled
            - proxy-arp
            - reply-only
          default: enabled
          description: 'Address Resolution Protocol mode'
        comment:
          type: str
          description: 'Short note for vlan resource'
        disabled:
          type: bool
          default: 'False'
          description: 'Set vlan resource disability'
        interface:
          type: str
          description: 'Name of physical interface on top of which VLAN will work'
        l2mtu:
          type: int
          description: 'Layer2 MTU. For VLANS this value is not configurable. [ Read more&gt;&gt;](https://wiki.mikrotik.com/wiki/Maximum_Transmission_Unit_on_RouterBoards "Maximum Transmission Unit on RouterBoards")'
        mtu:
          type: int
          default: 1500
          description: 'Layer3 Maximum transmission unit'
        name:
          type: str
          required: 'True'
          description: 'Interface name'
        use_service_tag:
          type: bool
          description: '802.1ad compatible Service Tag'
        vlan_id:
          type: int
          default: 1
          description: 'Virtual LAN identifier or tag that is used to distinguish VLANs. Must be equal for all computers that belong to the same VLAN.'
examples:
  - title: 'Using merged state'
    name: 'Merge configuration with device configuration'
    argument_spec:
      config:
        - name: vlan-100
          interface: br-trunk
          vlan_id: 100
          comment: 'new comment'
        - name: vlan-200
          interface: br-trunk
          vlan_id: 200
          comment: 'new comment'
      state: merged
    before: |
      /interface vlan
      add arp=reply-only interface=br-trunk name=vlan-100 vlan-id=100
    after: |
      # RouterOS Output
      #
      /interface vlan
      add arp=enabled comment=new name=vlan-100
      add comment=new interface=br-trunk name=vlan-200 vlan-id=200
    commands:
      - '/interface vlan set [ find name=vlan-100 ] arp=enabled comment=new'
      - '/interface vlan add comment=new interface=br-trunk name=vlan-200 vlan-id=200'
  - title: 'Using replaced state'
    name: 'Replace device configuration'
    argument_spec:
      config:
        - name: vlan-100
          interface: br-trunk
          vlan_id: 100
          comment: 'new comment'
      state: replaced
    before: |
      /interface vlan
      add arp=reply-only interface=br-trunk name=vlan-100 vlan-id=100
    after: |
      # RouterOS Output
      #
      /interface vlan
      add arp=enabled comment=new name=vlan-100
    commands:
      - '/interface vlan set [ find name=vlan-100 ] arp=enabled comment=new'
  - title: 'Using overridden state'
    name: 'Override device configuration'
    argument_spec:
      config:
        - name: vlan-new
          interface: br-trunk
          vlan_id: 100
          comment: 'new comment'
      state: overridden
    before: |
      /interface vlan
      add arp=reply-only interface=br-trunk name=vlan-100 vlan-id=100
    after: |
      # RouterOS Output
      #
      /interface vlan
      add comment=new interface=br-trunk name=vlan-new vlan-id=100
    commands:
      - '/interface vlan remove name=vlan-100'
      - '/interface vlan add comment=new interface=br-trunk name=vlan-new vlan-id=100'
      - '/system script run ansible-remove-invalid'
  - title: 'Using deleted state'
    name: 'Delete VLAN Interface'
    argument_spec:
      config:
        - name: vlan-100
          interface: br-trunk
          vlan_id: 100
      state: deleted
    before: |
      /interface vlan
      add arp=reply-only interface=br-trunk name=vlan-100 vlan-id=100
    after: |
      # RouterOS Output
      #
      /interface vlan
    commands:
      - '/interface vlan remove name=vlan-100'
      - '/system script run ansible-remove-invalid'
resource:
  name: vlan
  package: interface
  command: '/interface vlan'
  config_type: config
  keys:
    - name
  argument_spec:
    states:
      type: str
      choices:
        - merged
        - replaced
        - overridden
        - deleted
      default: merged
    config:
      type: list
      elements: dict
      options:
        arp:
          type: str
          choices:
            - disabled
            - enabled
            - proxy-arp
            - reply-only
          default: enabled
        comment:
          type: str
        disabled:
          type: bool
          default: 'False'
        interface:
          type: str
        l2mtu:
          type: int
        mtu:
          type: int
          default: 1500
        name:
          type: str
          required: 'True'
        use_service_tag:
          type: bool
        vlan_id:
          type: int
          default: 1
tests:
  facts:
    name: vlan
    type: config
    package: interface
    fixture_contents: |
      # RouterOS Output
      #
      /interface vlan
      add arp=reply-only interface=br-trunk name=vlan-100 vlan-id=100
    fixtures:
      - action: add
        values:
          arp: reply-only
          interface: br-trunk
          name: vlan-100
          vlan_id: '100'
  unit:
    module_name: ros_vlan
    fixture_contents: |
      # RouterOS Output
      #
      /interface vlan
      add arp=reply-only interface=br-trunk name=vlan-100 vlan-id=100
    tests:
      - commands:
          - '/interface vlan set [ find name=vlan-100 ] arp=enabled comment=new'
          - '/interface vlan add comment=new interface=br-trunk name=vlan-200 vlan-id=200'
        argument_spec:
          config:
            - { comment: 'new comment', interface: br-trunk, name: vlan-100, vlan_id: 100 }
            - { comment: 'new comment', interface: br-trunk, name: vlan-200, vlan_id: 200 }
          state: merged
      - commands:
          - '/interface vlan set [ find name=vlan-100 ] arp=enabled comment=new'
        argument_spec:
          config:
            - { comment: 'new comment', interface: br-trunk, name: vlan-100, vlan_id: 100 }
          state: replaced
      - commands:
          - '/interface vlan remove [ find name=vlan-100 ]'
          - '/interface vlan add comment=new interface=br-trunk name=vlan-new vlan-id=100'
          - '/system script run ansible-remove-invalid'
        argument_spec:
          config:
            - { comment: 'new comment', interface: br-trunk, name: vlan-new, vlan_id: 100 }
          state: overridden
      - commands:
          - '/interface vlan remove [ find name=vlan-100 ]'
          - '/system script run ansible-remove-invalid'
        argument_spec:
          config:
            - { interface: br-trunk, name: vlan-100, vlan_id: 100 }
          state: deleted
