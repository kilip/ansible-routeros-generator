vlan:
  versionAdded: 1.0.0
  validated: true
  package: interface
  command: /interface vlan
  documentations:
    short_description: VLAN Resource Module
    descriptions:
      - This module manages the vlan configuration of Mikrotik RouterOS network devices.
  module:
    keys: ["name"]
  options:
    vlan_id:
      required: "True"
    interface:
      required: "True"
  generator:
    url: https://wiki.mikrotik.com/wiki/Manual:Interface/VLAN
    tableIndex: 0
  tests:
    fixtures:
      interface_vlan_export: |
        # sep/05/2020 07:24:11 by RouterOS 6.47.2
        # software id = 
        #
        #
        #
        /interface vlan
        add interface=br-trunk name=vlan-100 vlan-id=100 arp=reply-only
    facts:
      asserts:
        - self.assertEqual(result[0]["name"], "vlan-100")
        - self.assertEqual(result[0]["interface"], "br-trunk")
        - self.assertEqual(result[0]["vlan_id"], 100)
  examples:
    # merged
    - name: Merge configuration with device configuration
      title: Using merged state
      argument_spec:
        config:
          - name: vlan-100
            interface: br-trunk
            vlan_id: 100
            comment: "new comment"
          - name: vlan-200
            interface: br-trunk
            vlan_id: 200
            comment: "new comment"
        state: merged
      commands:
        - /interface vlan set [ find name=vlan-100 ] comment="new comment" arp=enabled
        - /interface vlan add name=vlan-200 interface=br-trunk vlan-id=200 comment="new comment"
      pre: |
        [admin@MikroTik] > /interface vlan export
        /interface vlan
        add interface=br-trunk name=vlan-100 vlan-id=100 arp=reply-only
      post: |
        [admin@MikroTik] > /interface vlan export
        /interface vlan
        add interface=br-trunk name=vlan-100 vlan-id=100 comment="new comment"
        add interface=br-trunk name=vlan-200 vlan-id=200 comment="new comment"

    # replaced
    - name: Replace device configuration
      title: Using replaced state
      argument_spec:
        config:
          - name: vlan-100
            interface: br-trunk
            vlan_id: 100
            comment: "new comment"
        state: replaced
      commands:
        - /interface vlan set [ find name=vlan-100 ] arp=enabled
        - /interface vlan set [ find name=vlan-100 ] interface=br-trunk vlan-id=100 comment="new comment"
      pre: |
        [admin@MikroTik] > /interface vlan export
        /interface vlan
        add interface=br-trunk name=vlan-100 vlan-id=100 arp=reply-only
      post: |
        [admin@MikroTik] > /interface vlan export
        /interface vlan
        add interface=br-trunk name=vlan-100 vlan-id=100 comment="new comment"
        add interface=br-trunk name=vlan-200 vlan-id=200 comment="new comment"

    # overridden
    - name: Override device configuration
      title: Using overridden state
      argument_spec:
        config:
          - name: vlan-new
            interface: br-trunk
            vlan_id: 100
            comment: "new comment"
        state: overridden
      commands:
        - /interface vlan remove [ find name=vlan-100 ]
        - /interface vlan add name=vlan-new interface=br-trunk vlan-id=100 comment="new comment"
        - /system script run ansible-remove-invalid
      pre: |
        [admin@MikroTik] > /interface vlan export
        /interface vlan
        add interface=br-trunk name=vlan-100 vlan-id=100 arp=reply-only
      post: |
        [admin@MikroTik] > /interface vlan export
        /interface vlan
        add name=vlan-new interface=br-trunk vlan-id=100 comment="new comment"

    # deleted
    - name: Delete VLAN Interface
      title: Using deleted state
      argument_spec:
        config:
          - name: vlan-100
            interface: br-trunk
            vlan_id: 100
        state: deleted
      commands:
        - /interface vlan remove [ find name=vlan-100 ]
        - /system script run ansible-remove-invalid
      pre: |
        [admin@MikroTik] > /interface vlan export
        /interface vlan
        add interface=br-trunk name=vlan-100 vlan-id=100 arp=reply-only
      post: |
        [admin@MikroTik] > /interface vlan export
